import{r as u,w as te,o as re,c as x,a as c,b as l,t as f,d as n,e as s,g as M,f as p,h as i,u as o,F as C,i as N,j as g,n as se,l as le,m as $,v as Y,p as I}from"./index-CzTVdHJk.js";import{_ as ne,a as oe}from"./AdminLayout-Dhg-TmsD.js";import{_ as de,a as ie,b as ue,c as L,d as w,e as ce,f as y,m as ge,g as fe,h as pe,i as ve,j as me,k as be,l as ye}from"./PaginationPrevious.vue_vue_type_script_setup_true_lang-CXNmaqAe.js";import{_ as R,a as we,b as xe}from"./DeleteConfirmDialog-UK4PqW0e.js";import{a as ke}from"./index-gNOMr9Xr.js";import{g as _e,a as he,u as Ae,c as Ce,b as $e,d as Te}from"./prompts-DVSTLn-0.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./http-VbNDWnN5.js";const q=[{value:"reply_comment",label:"回复评论"},{value:"reply_message",label:"回复消息"},{value:"post",label:"发帖"}],De={class:"space-y-5 sm:space-y-6"},Se={class:"mb-4 flex items-center justify-between"},Pe={class:"flex gap-2"},Ue={class:"flex items-center justify-end gap-2"},Ve=["onClick"],Oe={key:0,class:"mt-4"},Me={class:"relative z-10 w-full max-w-xl rounded-xl bg-white p-6 shadow-lg dark:bg-gray-900"},Ne={class:"mb-4 text-lg font-semibold"},Re={key:0},je=["value"],ze=["value"],Be={class:"flex justify-end gap-3 pt-2"},Fe={key:1,class:"fixed top-4 right-4 bg-red-500 text-white p-2 rounded z-50"},Qe={__name:"index",setup(Ie){const G=u("提示词模板"),k=u(!1),v=u(!1),T=u([]),D=u(""),S=u([]),P=u(!1),_=u(!1),U=u(!1),V=u(null),j=u({top:0,left:0,width:0,height:0}),z=u(null),m=u(""),h=u(1),H=u(20),O=u(0);u(""),u(!1);function K(){try{const t=localStorage.getItem("profile"),e=localStorage.getItem("role");t&&(z.value=JSON.parse(t)),e&&(m.value=e)}catch(t){console.error("获取用户信息失败:",t)}}async function B(){const t=await ke({}),e=t&&t.results?t.results:t;S.value=Array.isArray(e)?e.map(a=>({id:a.id??a.pk??a.uuid,name:a.username||a.name||a.email||`用户${a.id}`})):[]}async function A(){var t,e;try{const a=await _e({page:h.value});a&&a.results&&(T.value=Array.isArray(a.results)?a.results.map(r=>{var b;return{id:r.id,name:r.name,type:r.scene||r.type,user:((b=r.owner_detail)==null?void 0:b.username)||r.user,isActive:r.enabled!==void 0?r.enabled:r.isActive,content:r.content,createdAt:r.createdAt||r.created_at}}):[],O.value=a.count||0)}catch(a){console.error("Failed to fetch templates:",a),T.value=[],O.value=0,f.error("获取模板列表失败",{description:((e=(t=a.response)==null?void 0:t.data)==null?void 0:e.message)||a.message||"获取模板列表时发生错误"})}}const d=u({id:"",name:"",scene:"",owner_id:"",enabled:!0,content:"",createdAt:""});async function Q(){var t;v.value=!1,D.value="",E(),m.value==="user"&&((t=z.value)!=null&&t.id)&&(d.value.owner_id=z.value.id),m.value==="admin"&&S.value.length===0&&await B(),P.value=!0}async function W(t){var e,a;v.value=!0,D.value=t.id,P.value=!0,m.value==="admin"&&S.value.length===0&&await B();try{const r=await he(String(t.id));d.value={id:r.id??t.id,name:r.name??t.name,scene:r.scene??t.type,owner_id:r.owner_detail.id,enabled:typeof r.enabled=="boolean"?r.enabled:typeof r.isActive=="boolean"?r.isActive:t.isActive,content:r.content??t.content,createdAt:r.createdAt??r.created_at??t.createdAt}}catch(r){console.error("Failed to fetch template detail:",r),f.error("获取模板详情失败",{description:((a=(e=r.response)==null?void 0:e.data)==null?void 0:a.message)||r.message||"获取模板详情时发生错误"}),d.value={id:t.id,name:t.name,scene:t.type,owner_id:t.user,enabled:t.isActive,content:t.content,createdAt:t.createdAt}}}function F(){P.value=!1,v.value=!1,D.value="",E()}function E(){d.value={id:"",name:"",scene:"",owner_id:"",enabled:!0,content:"",createdAt:""}}async function X(){var t,e;if(!k.value){if(!d.value.name||d.value.name.trim()===""){f.error("请填写模板名称",{description:"模板名称不能为空"});return}if(m.value==="admin"&&(!d.value.owner_id||d.value.owner_id==="")){f.error("请选择所属用户",{description:"所属用户不能为空"});return}if(!d.value.content||d.value.content.trim()===""){f.error("请填写模板内容",{description:"模板内容不能为空"});return}k.value=!0;try{const a={owner_id:d.value.owner_id,owner:d.value.owner_id,scene:d.value.scene,name:d.value.name.trim(),content:d.value.content.trim(),enabled:d.value.enabled};v.value?await Ae(D.value,a):m.value==="user"?await Ce(a):await $e(a),f.success(v.value?"模板更新成功":"模板新增成功"),F(),await A()}catch(a){console.error(v.value?"更新失败:":"新增失败:",a),f.error(v.value?"更新失败":"新增失败",{description:((e=(t=a.response)==null?void 0:t.data)==null?void 0:e.message)||a.message||(v.value?"更新模板时发生错误":"新增模板时发生错误")})}finally{k.value=!1}}}function Z(t,e){console.log("onDelete called with:",t,e),V.value=t;const a=e.target.getBoundingClientRect();j.value={top:a.top,left:a.left,width:a.width,height:a.height,bottom:a.bottom},console.log("Setting showDeleteDialog to true, triggerRect:",j.value),_.value=!0}async function ee(){var t,e;if(V.value){U.value=!0;try{await Te(V.value.id),f.success("删除成功"),await A(),J()}catch(a){console.error("删除失败:",a),f.error("删除失败",{description:((e=(t=a.response)==null?void 0:t.data)==null?void 0:e.message)||a.message||"删除模板时发生错误"})}finally{U.value=!1}}}function J(){_.value=!1,V.value=null,U.value=!1}function ae(t){const e=q.find(a=>a.value===t);return e?e.label:t}return te(h,async t=>{var e,a;console.log("Page changed to:",t);try{await A()}catch(r){console.error("分页加载失败:",r),f.error("分页加载失败",{description:((a=(e=r.response)==null?void 0:e.data)==null?void 0:a.message)||r.message||"分页加载时发生错误"})}}),re(async()=>{K(),m.value==="admin"?await Promise.all([B(),A()]):await A()}),(t,e)=>(c(),x(ne,null,{default:l(()=>[n(oe,{pageTitle:G.value},null,8,["pageTitle"]),s("div",De,[n(de,null,{default:l(()=>[s("div",Se,[e[7]||(e[7]=s("div",{class:"flex items-center gap-3"},null,-1)),s("div",Pe,[n(R,{size:"sm",onClick:Q},{default:l(()=>[...e[6]||(e[6]=[i("新增",-1)])]),_:1})])]),n(o(ie),{class:"[&_td]:py-3.5 [&_th]:py-3.5"},{default:l(()=>[n(o(ue),null,{default:l(()=>[n(o(L),null,{default:l(()=>[n(o(w),{class:"whitespace-nowrap"},{default:l(()=>[...e[8]||(e[8]=[i("序号",-1)])]),_:1}),n(o(w),{class:"whitespace-nowrap"},{default:l(()=>[...e[9]||(e[9]=[i("模板名称",-1)])]),_:1}),n(o(w),{class:"whitespace-nowrap"},{default:l(()=>[...e[10]||(e[10]=[i("模板类型",-1)])]),_:1}),n(o(w),{class:"whitespace-nowrap"},{default:l(()=>[...e[11]||(e[11]=[i("所属用户",-1)])]),_:1}),n(o(w),{class:"whitespace-nowrap"},{default:l(()=>[...e[12]||(e[12]=[i("是否激活",-1)])]),_:1}),n(o(w),{class:"whitespace-nowrap"},{default:l(()=>[...e[13]||(e[13]=[i("创建时间",-1)])]),_:1}),n(o(w),{class:"whitespace-nowrap text-right"},{default:l(()=>[...e[14]||(e[14]=[i("操作",-1)])]),_:1})]),_:1})]),_:1}),n(o(ce),null,{default:l(()=>[T.value.length?(c(!0),p(C,{key:0},N(T.value,(a,r)=>(c(),x(o(L),{key:a.id},{default:l(()=>[n(o(y),{class:"whitespace-nowrap"},{default:l(()=>[i(g(r+1),1)]),_:2},1024),n(o(y),{class:"whitespace-nowrap"},{default:l(()=>[i(g(a.name),1)]),_:2},1024),n(o(y),{class:"whitespace-nowrap"},{default:l(()=>[i(g(ae(a.type)),1)]),_:2},1024),n(o(y),{class:"whitespace-nowrap"},{default:l(()=>[i(g(a.user),1)]),_:2},1024),n(o(y),{class:"whitespace-nowrap"},{default:l(()=>[s("span",{class:se(["inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ring-1 ring-inset",a.isActive?"bg-emerald-50 text-emerald-600 ring-emerald-200 dark:bg-emerald-500/10 dark:text-emerald-400 dark:ring-emerald-500/30":"bg-rose-50 text-rose-600 ring-rose-200 dark:bg-rose-500/10 dark:text-rose-400 dark:ring-rose-500/30"])},g(a.isActive?"启用":"停用"),3)]),_:2},1024),n(o(y),{class:"whitespace-nowrap"},{default:l(()=>[i(g(o(ge)(a.createdAt)),1)]),_:2},1024),n(o(y),{class:"text-right whitespace-nowrap"},{default:l(()=>[s("div",Ue,[n(R,{size:"sm",variant:"outline",onClick:b=>W(a)},{default:l(()=>[...e[15]||(e[15]=[i("编辑",-1)])]),_:1},8,["onClick"]),s("button",{class:"inline-flex items-center justify-center font-medium gap-2 rounded-lg transition px-4 py-3 text-sm bg-white text-gray-700 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 dark:bg-gray-800 dark:text-gray-400 dark:ring-gray-700 dark:hover:bg-white/[0.03] dark:hover:text-gray-300 text-rose-600 ring-rose-200 hover:bg-rose-50 dark:text-rose-400 dark:ring-rose-500/30",onClick:b=>Z(a,b)}," 删除 ",8,Ve)])]),_:2},1024)]),_:2},1024))),128)):(c(),x(o(L),{key:1},{default:l(()=>[n(o(y),{colspan:6,class:"py-16 text-center text-gray-400 dark:text-white/40"},{default:l(()=>[...e[16]||(e[16]=[i("暂无数据",-1)])]),_:1})]),_:1}))]),_:1})]),_:1}),O.value>0?(c(),p("div",Oe,[n(o(fe),{page:h.value,"onUpdate:page":e[0]||(e[0]=a=>h.value=a),total:O.value,"items-per-page":H.value,"sibling-count":1},{default:l(()=>[n(o(pe),null,{default:l(({items:a})=>[n(o(ve)),(c(!0),p(C,null,N(a,(r,b)=>(c(),p(C,{key:b},[r.type==="page"?(c(),x(o(me),{key:0,value:r.value,"is-active":r.value===h.value},{default:l(()=>[i(g(r.value),1)]),_:2},1032,["value","is-active"])):(c(),x(o(be),{key:1,index:b},null,8,["index"]))],64))),128)),n(o(ye))]),_:1})]),_:1},8,["page","total","items-per-page"])])):M("",!0)]),_:1}),P.value?(c(),x(we,{key:0,fullScreenBackdrop:!0,onClose:F},{body:l(()=>[s("div",Me,[s("h3",Ne,g(v.value?"编辑提示词模板":"新增提示词模板"),1),s("form",{onSubmit:le(X,["prevent"]),class:"space-y-4"},[s("div",null,[e[17]||(e[17]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[i("模板名称"),s("span",{class:"text-error-500"},"*")],-1)),$(s("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>d.value.name=a),type:"text",placeholder:"如：客服问候模板",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[Y,d.value.name]])]),m.value==="admin"?(c(),p("div",Re,[e[19]||(e[19]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[i("所属用户"),s("span",{class:"text-error-500"},"*")],-1)),$(s("select",{"onUpdate:modelValue":e[2]||(e[2]=a=>d.value.owner_id=a),class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"},[e[18]||(e[18]=s("option",{value:"",disabled:""},"请选择用户",-1)),(c(!0),p(C,null,N(S.value,a=>(c(),p("option",{key:a.id,value:a.id},g(a.name),9,je))),128))],512),[[I,d.value.owner_id]])])):M("",!0),s("div",null,[e[21]||(e[21]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"模板类型",-1)),$(s("select",{"onUpdate:modelValue":e[3]||(e[3]=a=>d.value.scene=a),class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},[e[20]||(e[20]=s("option",{value:"",disabled:""},"请选择模板类型",-1)),(c(!0),p(C,null,N(o(q),a=>(c(),p("option",{key:a.value,value:a.value},g(a.label),9,ze))),128))],512),[[I,d.value.scene]])]),s("div",null,[e[23]||(e[23]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"是否激活",-1)),$(s("select",{"onUpdate:modelValue":e[4]||(e[4]=a=>d.value.enabled=a),class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},[...e[22]||(e[22]=[s("option",{value:!0},"是",-1),s("option",{value:!1},"否",-1)])],512),[[I,d.value.enabled]])]),s("div",null,[e[24]||(e[24]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[i("内容"),s("span",{class:"text-error-500"},"*")],-1)),$(s("textarea",{"onUpdate:modelValue":e[5]||(e[5]=a=>d.value.content=a),rows:"3",placeholder:"请输入模板内容",class:"dark:bg-dark-900 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[Y,d.value.content]])]),s("div",Be,[n(R,{type:"button",variant:"outline",onClick:F},{default:l(()=>[...e[25]||(e[25]=[i("取消",-1)])]),_:1}),n(R,{type:"submit",disabled:k.value},{default:l(()=>[i(g(k.value?"保存中...":"保存"),1)]),_:1},8,["disabled"])])],32)])]),_:1})):M("",!0),n(xe,{isOpen:_.value,title:"删除",description:"确定要删除吗？此操作不可撤销。",isLoading:U.value,triggerRect:j.value,onClose:J,onConfirm:ee},null,8,["isOpen","isLoading","triggerRect"]),_.value?(c(),p("div",Fe," 弹窗应该显示: "+g(_.value),1)):M("",!0)])]),_:1}))}};export{Qe as default};
